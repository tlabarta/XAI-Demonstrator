<html>
<script src="d3.min.js"></script>
<script src="utils.js"></script>
<script src="socket.io.js"></script>


<head>
    <link rel="stylesheet" href="new_css_test.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Mulish:wght@200;300;400;500;600;700;800&display=swap"
        rel="stylesheet">

</head>

<body>
    <div class="logos">
       <img src="website_img/Fraunhofer_HHI.png" width="261px" height="71px">
    </div>

    <div class="main">

        <div class="title">
            <span> Explainable AI Demo</span>
        </div>


        <button class="action_button" id="action_button"><i class="fa fa-refresh"></i></button>
        <select id="xaiMethodDropdown">
            <option value="lrp">LRP</option>
            <option value="crp">CRP</option>
        </select>

        <div class="container">
            <div class="output pane">
                <div class="top-row">
                    <div class="smallpane_input">
                        <div class="header">
                            <span>Input</span>
                        </div>
                        <div class='input'>
                            <img id="input_img" src="website_img/temp_image.png">
                            <div class="predictionandlabel">
                                <p id="label">Actual class:  </p>
                                <p id="prediction">Predicted class:  </p>
                            </div>
                        </div>
                    </div>



                    <div class="smallpane_explanation">
                        <div class="header">
                            <span>Explanation</span>
                        </div>
                        <div class="explanation">
                            <img id="explanation_img" src="website_img/heatmap.png">
                            <div class="predictionandlabel">
                                <p id="currentXAIselection">XAI Method:  </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="xai_info">
                    <p id="lrpInfo" class="xai-info-text">Layer-wise Relevance Propagation (LRP) is a technique that brings such explainability and scales to potentially highly complex deep neural networks. It operates by propagating the prediction backward in the neural network, using a set of purposely designed propagation rules <a href="https://doi.org/10.1007/978-3-030-28954-6_10">(Montavon et al. 2019)</a>. </p>
                    <p id="crpInfo" class="xai-info-text">Concept Relevance Propagation (CRP) is a cutting-edge explainability method for deep neural networks that allows for the understanding of AI predictions on the concept level. As an advancement of LRP, CRP indicates not only which input features are relevant, but also communicates which concepts are used, where they are located in the input and which parts of the neural network are responsible. Thus, CRP sets new standards in AI validation and interaction with a high level of human-understandability <a href="https://www.hhi.fraunhofer.de/en/departments/ai/technologies-and-solutions/concept-relevance-propagation.html">(Samek et al.)</a>. </p>
                </div>

            </div>

            <div class="network pane">
                <div class="network-container">
                    <div class="header">
                        <span>Network</span>
                    </div>
                    <div class="network"> </div>
                        <object id="network-svg" data="website_img/nn.svg" type="image/svg+xml" style="width: 100%; max-width: 100%; height: 100%;">
                        Your browser does not support SVG
                        </object>
                </div>
            </div>

    </div>

</body>

<script>

    const socket = io();

    // Get the selected XAI method from the dropdown
    var xaiMethodSelector = document.getElementById('xaiMethodDropdown');
    var selectedXaiMethod = xaiMethodSelector.value;

    // Add an event listener to trigger the 'videoframe' event when the page loads
    document.addEventListener('DOMContentLoaded', function () {
        // Set explanation text to default
        updateXaiInfoText(xaiMethodSelector.value);


        // Emit 'videoframe' event with dataset ID and selected XAI method
        socket.emit('select_input', {xai_method: selectedXaiMethod });
        socket.emit('explain_prediction', {xai_method: xaiMethodSelector.value });

               // Add an event listener for the change event on the dropdown
        xaiMethodSelector.addEventListener('change', function () {
            // Emit 'explain_prediction' event with updated XAI method
            updateXaiInfoText(xaiMethodSelector.value);
            socket.emit('explain_prediction', {xai_method: xaiMethodSelector.value });

        });

    });

    xaiMethodSelector.addEventListener('change', function () {
    // Emit 'explain_prediction' event with updated XAI method
    socket.emit('explain_prediction', {xai_method: xaiMethodSelector.value });

    });

    // Event listener for the button click
    document.getElementById('action_button').addEventListener('click', function () {
        // Emit a custom event to the server
        socket.emit('button_click', {xai_method: xaiMethodSelector.value });
    });

    // Listen for the 'input_image' event from the server
    socket.on('input_image', function (data) {
        // Update the src attribute of the img element with the received image path

        document.getElementById('input_img').src = data.data + '?' + new Date().getTime();

    });

    // Listen for the 'prediction' event from the server
    socket.on("prediction", function (data) {
        var prediction = data.prediction;
        var actual_label = data.actual_label;
        console.log(prediction);

        const responseText = document.getElementById('prediction');
        responseText.textContent = 'Predicted number: ' + String(prediction);

        const actLabel = document.getElementById('label');
        actLabel.textContent = 'Actual number: ' + String(actual_label);



    });

    // Listen for the 'heatmap' event from the server
    socket.on("heatmap", function (data) {
        var heatmapResponse = data.data;
        console.log(heatmapResponse)
        document.getElementById('explanation_img').src = heatmapResponse + '?' + new Date().getTime();


    });

        // Function to update xai_info text based on the selected value
    function updateXaiInfoText(selectedXaiMethod) {
        // Hide all xai-info-text elements
        document.querySelectorAll('.xai-info-text').forEach(function(element) {
            element.style.display = 'none';
        });

        // Show the relevant xai-info-text based on the selected XAI method
        switch (selectedXaiMethod) {
            case 'lrp':
                document.getElementById('lrpInfo').style.display = 'block';
                break;
            case 'crp':
                document.getElementById('crpInfo').style.display = 'block';
                break;
            // Add more cases as needed for other XAI methods
            // ...
        }
    }




</script>

</html>
